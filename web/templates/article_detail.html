{% extends "base.html" %}

{% block title %}{{ article.headline }}{% endblock %}
{% block meta_description %}{{ article.meta_description or article.subtitle or '' }}{% endblock %}
{% block meta_keywords %}{{ article.meta_keywords or '' }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_title %}{{ article.og_title or article.headline }}{% endblock %}
{% block og_description %}{{ article.og_description or article.meta_description or article.subtitle or '' }}{% endblock %}
{% block og_image %}{% if article.og_image_url %}{{ article.og_image_url }}{% elif article.image_url %}{{ article.image_url }}{% elif article.image_filename %}{{ base_url }}/static/images/articles/{{ article.image_filename }}{% else %}{{ base_url }}/static/images/og-default.jpg{% endif %}{% endblock %}

{% block head_extra %}
<!-- JSON-LD NewsArticle -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": {{ article.headline | tojson }},
    "description": {{ (article.meta_description or article.subtitle or '') | tojson }},
    {% if article.image_url or article.image_filename %}
    "image": "{% if article.image_url %}{{ article.image_url }}{% else %}{{ base_url }}/static/images/articles/{{ article.image_filename }}{% endif %}",
    {% endif %}
    "datePublished": "{{ article.created_at or '' }}",
    "dateModified": "{{ article.updated_at or article.created_at or '' }}",
    "author": {
        "@type": "Organization",
        "name": "GoalFeed"
    },
    "publisher": {
        "@type": "Organization",
        "name": "GoalFeed"
    }
}
</script>
{% endblock %}

{% block content %}
<article class="gf-container gf-container--narrow gf-section">

    <!-- Hero image -->
    {% if article.image_url or article.image_filename %}
    <div class="gf-article-hero">
        {% if article.image_url %}
        <img src="{{ article.image_url }}" alt="{{ article.headline }}">
        {% else %}
        <img src="/static/images/articles/{{ article.image_filename }}" alt="{{ article.headline }}">
        {% endif %}
    </div>
    {% endif %}

    <!-- Badges -->
    <div class="gf-article__badges">
        {% set sport_info = SPORT_DISPLAY.get(article.sport, {}) %}
        <a href="/category/{{ article.sport }}" class="gf-badge gf-badge--sport">
            {{ ICONS.get(article.sport, '') | safe }}
            {{ sport_info.get('name', article.sport) }}
        </a>

        {% if article.status and article.status in STATUS_CONFIG %}
        {% set status_info = STATUS_CONFIG[article.status] %}
        <span class="gf-badge {% if article.status == 'CONFIRMADO' %}gf-badge--confirmed{% elif article.status == 'RUMOR' %}gf-badge--rumor{% else %}gf-badge--breaking{% endif %}">
            {{ ICONS.get(article.status, '') | safe }}
            {{ status_info.label }}
        </span>
        {% endif %}

        {% if article.category %}
        <span class="gf-badge gf-badge--category">{{ article.category }}</span>
        {% endif %}
    </div>

    <!-- Headline -->
    <h1 class="gf-article__headline">{{ article.headline }}</h1>

    <!-- Subtitle -->
    {% if article.subtitle %}
    <p class="gf-article__subtitle">{{ article.subtitle }}</p>
    {% endif %}

    <!-- Meta -->
    <div class="gf-article__meta">
        {% if article.created_at %}
        <time>{{ article.created_at[:16].replace('T', ' ') }}</time>
        {% endif %}
        {% if article.view_count %}
        <span>{{ article.view_count }} lecturas</span>
        {% endif %}
    </div>

    <!-- Body -->
    <div class="gf-prose">
        {{ article.body_html | safe }}
    </div>

    <!-- Source -->
    {% if article.source_url %}
    <div class="gf-source-box">
        <p>
            Fuente original:
            <a href="{{ article.source_url }}" target="_blank" rel="noopener noreferrer">
                {{ article.source_name or 'Ver fuente' }}
            </a>
        </p>
    </div>
    {% endif %}
</article>

<!-- Comments Section -->
<section class="gf-container gf-container--narrow gf-comments-section" id="comments-section" data-article-id="{{ article.id }}">
    <h2 class="gf-section__title">Comentarios</h2>

    <!-- Comments list -->
    <div class="gf-comments__list" id="comments-list">
        <!-- Comments loaded via JS -->
    </div>

    <!-- Comment form -->
    <div class="gf-comments__form-wrapper" id="comment-form-wrapper">
        {% if current_user %}
        <!-- Logged in: show form -->
        <form class="gf-comments__form" id="comment-form">
            <div class="gf-comments__form-header">
                <div class="gf-comments__form-avatar">{{ current_user.initials }}</div>
                <span class="gf-comments__form-name">{{ current_user.name }}</span>
            </div>
            <textarea class="gf-comments__textarea" id="comment-text" placeholder="Escribe un comentario..." rows="3" maxlength="2000"></textarea>
            <div class="gf-comments__form-actions">
                <span class="gf-comments__char-count" id="comment-char-count">0 / 2000</span>
                <button type="submit" class="gf-btn gf-btn--primary gf-comments__submit">Comentar</button>
            </div>
        </form>
        {% else %}
        <!-- Not logged in: blurred form with overlay -->
        <div class="gf-comments__gate">
            <div class="gf-comments__form gf-comments__form--blurred" aria-hidden="true">
                <div class="gf-comments__form-header">
                    <div class="gf-comments__form-avatar">?</div>
                    <span class="gf-comments__form-name">Usuario</span>
                </div>
                <textarea class="gf-comments__textarea" placeholder="Escribe un comentario..." rows="3" disabled></textarea>
                <div class="gf-comments__form-actions">
                    <span class="gf-comments__char-count">0 / 2000</span>
                    <button type="button" class="gf-btn gf-btn--primary gf-comments__submit" disabled>Comentar</button>
                </div>
            </div>
            <div class="gf-comments__gate-overlay">
                <div class="gf-comments__gate-card">
                    <svg class="gf-comments__gate-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <p class="gf-comments__gate-text">Para poder comentar necesitas estar registrado</p>
                    <button class="gf-btn gf-btn--primary" onclick="alert('Funcionalidad de registro proximamente')">Registrarse</button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Related articles -->
{% if related %}
<section class="gf-container gf-related">
    <h2 class="gf-section__title">Articulos Relacionados</h2>
    <div class="gf-grid gf-grid--4">
        {% for article in related %}
        {% include "partials/article_card.html" %}
        {% endfor %}
    </div>
</section>
{% endif %}
{% endblock %}
